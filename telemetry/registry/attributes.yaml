# Cluster Whisperer Attribute Definitions
# Custom attributes for cluster-whisperer tracing conventions
#
# Categories:
# - OTel References: gen_ai.*, process.*, error.* (imported via ref:)
# - OpenLLMetry: traceloop.* (custom definitions for vendor conventions)
# - Custom: cluster_whisperer.* (project-specific attributes)

groups:
  # ==========================================================================
  # ROOT SPAN ATTRIBUTES
  # Used by both CLI mode (withAgentTracing) and MCP mode (withMcpRequestTracing)
  # ==========================================================================
  - id: registry.cluster_whisperer.root
    type: attribute_group
    display_name: Root Span Attributes
    brief: Attributes for root investigation/tool spans
    attributes:
      - id: cluster_whisperer.service.operation
        type: string
        stability: development
        brief: The high-level operation type
        examples: ["investigate", "kubectl_get", "kubectl_describe", "kubectl_logs"]

      - id: cluster_whisperer.invocation.mode
        type:
          members:
            - id: cli
              value: cli
              brief: Invoked via CLI (node dist/index.js)
              stability: development
            - id: mcp
              value: mcp
              brief: Invoked via MCP server (e.g., from Claude Code)
              stability: development
        stability: development
        brief: How the agent was invoked
        note: >
          No OTel semconv exists for invocation mode. The closest analogy is faas.trigger
          (serverless trigger type) but that's scoped to FaaS. This custom attribute follows
          OTel convention of namespacing vendor-specific attributes under the service name.

      - id: cluster_whisperer.user.question
        type: string
        stability: development
        brief: User's natural language question (content-gated)
        note: Only captured when OTEL_CAPTURE_AI_PAYLOADS=true. CLI mode only.
        examples: ["Find the broken pod and tell me why it's failing"]

      - id: gen_ai.input.messages
        type: string
        stability: development
        brief: JSON-stringified input messages in OTel v1.37+ parts format (content-gated)
        note: >
          Only captured when OTEL_CAPTURE_AI_PAYLOADS=true.
          Manual workaround for OpenLLMetry-JS using deprecated gen_ai.prompt.N format.
          Format: [{"role":"user","parts":[{"type":"text","content":"..."}]}]
          See PRD #21 and https://opentelemetry.io/docs/specs/semconv/gen-ai/gen-ai-spans/
        examples: ['[{"role":"user","parts":[{"type":"text","content":"Find the broken pod"}]}]']

      - id: gen_ai.output.messages
        type: string
        stability: development
        brief: JSON-stringified output messages in OTel v1.37+ parts format (content-gated)
        note: >
          Only captured when OTEL_CAPTURE_AI_PAYLOADS=true.
          Manual workaround for OpenLLMetry-JS using deprecated gen_ai.completion.N format.
          Format: [{"role":"assistant","parts":[{"type":"text","content":"..."}],"finish_reason":"end_turn"}]
          See PRD #21 and https://opentelemetry.io/docs/specs/semconv/gen-ai/gen-ai-spans/
        examples: ['[{"role":"assistant","parts":[{"type":"text","content":"The pod is failing..."}],"finish_reason":"end_turn"}]']

  # ==========================================================================
  # TOOL SPAN ATTRIBUTES
  # Used by withToolTracing() for agentic tool execution spans (CLI mode)
  # ==========================================================================
  - id: registry.cluster_whisperer.tool
    type: attribute_group
    display_name: Tool Span Attributes
    brief: GenAI semantic convention attributes for agentic tool execution spans
    note: >
      Set by withToolTracing() on spans created by OpenLLMetry's withTool().
      Both gen_ai.* (OTel GenAI semconv) and traceloop.* (OpenLLMetry) attributes
      coexist on the same span for ecosystem compatibility.
      See PRD #23 and https://opentelemetry.io/docs/specs/semconv/gen-ai/gen-ai-spans/
    attributes:
      # OTel GenAI semantic convention references
      - ref: gen_ai.operation.name
      - ref: gen_ai.tool.name
      - ref: gen_ai.tool.type
      - ref: gen_ai.tool.call.id
      - ref: gen_ai.tool.description

      # Custom gen_ai.tool.call.* attributes
      # These are in the OTel GenAI span spec but not yet in the v1.37.0 registry
      # as standalone attributes. Defined here to document what we set on spans.
      - id: gen_ai.tool.call.arguments
        type: string
        stability: development
        brief: JSON-stringified tool input arguments (content-gated)
        note: >
          Only captured when OTEL_CAPTURE_AI_PAYLOADS=true.
          Not yet a standalone attribute in OTel semconv v1.37.0 registry,
          but part of the execute_tool span spec.
          See https://opentelemetry.io/docs/specs/semconv/gen-ai/gen-ai-spans/
        examples: ['{"resource":"pods","namespace":"all"}']

      - id: gen_ai.tool.call.result
        type: string
        stability: development
        brief: Tool execution result as string (content-gated)
        note: >
          Only captured when OTEL_CAPTURE_AI_PAYLOADS=true.
          Not yet a standalone attribute in OTel semconv v1.37.0 registry,
          but part of the execute_tool span spec.
          See https://opentelemetry.io/docs/specs/semconv/gen-ai/gen-ai-spans/
        examples: ["NAME  READY  STATUS  RESTARTS  AGE\nnginx  1/1  Running  0  5m"]

  # ==========================================================================
  # LLM SPAN ATTRIBUTES
  # Used by chat.anthropic/anthropic.chat spans (OpenLLMetry auto-instrumentation)
  # ==========================================================================
  - id: registry.cluster_whisperer.llm
    type: attribute_group
    display_name: LLM Span Attributes
    brief: GenAI semantic convention attributes for LLM/chat completion spans
    note: >
      Attributes set on chat.anthropic spans created by OpenLLMetry's
      auto-instrumentation of the Anthropic SDK. gen_ai.tool.definitions
      describes which tools were available during each LLM reasoning step.
      See PRD #23 M3 and https://opentelemetry.io/docs/specs/semconv/gen-ai/gen-ai-spans/
    attributes:
      - id: gen_ai.tool.definitions
        type: string
        stability: development
        brief: JSON array of tool definitions available to the LLM
        note: >
          Not yet in OTel semconv v1.37.0 registry.
          Datadog maps this to meta.tool_definitions in LLM Observability.
          Contains tool names, descriptions, and parameter schemas.
        examples: ['[{"name":"kubectl_get","description":"List Kubernetes resources...","parameters":{...}}]']

  # ==========================================================================
  # MCP-SPECIFIC ATTRIBUTES
  # Used by MCP mode (withMcpRequestTracing) for tool execution tracking
  # ==========================================================================
  - id: registry.cluster_whisperer.mcp
    type: attribute_group
    display_name: MCP Tool Attributes
    brief: MCP tool execution attributes with GenAI semantic convention references
    attributes:
      - id: cluster_whisperer.mcp.tool.name
        type: string
        stability: development
        brief: The MCP tool name
        note: >
          OTel has MCP semantic conventions (development stability) as of 2025.
          See https://opentelemetry.io/docs/specs/semconv/gen-ai/mcp/
          This custom attribute provides MCP-specific tool identification.
        examples: ["kubectl_get", "kubectl_describe", "kubectl_logs", "investigate"]

      # OTel GenAI semantic convention references
      - ref: gen_ai.operation.name
      - ref: gen_ai.tool.name
      - ref: gen_ai.tool.type
      - ref: gen_ai.tool.call.id

  # ==========================================================================
  # SUBPROCESS ATTRIBUTES
  # Used by kubectl execution spans (src/utils/kubectl.ts)
  # ==========================================================================
  - id: registry.cluster_whisperer.subprocess
    type: attribute_group
    display_name: Subprocess Attributes
    brief: kubectl subprocess execution attributes with Process semantic convention references
    attributes:
      # OTel Process semantic convention references
      - ref: process.executable.name
      - ref: process.command_args
      - ref: process.exit.code

      # OTel Error semantic convention reference
      - ref: error.type

      # Custom k8s attributes
      - id: cluster_whisperer.k8s.namespace
        type: string
        stability: development
        brief: Kubernetes namespace from -n flag
        note: Extracted from command args when -n flag is present
        examples: ["default", "kube-system", "monitoring"]

      - id: cluster_whisperer.k8s.output_size_bytes
        type: int
        stability: development
        brief: Byte length of kubectl stdout
        note: Only set on successful execution. Useful for debugging large responses.
        examples: [1234, 5678, 102400]

  # ==========================================================================
  # OPENLLMETRY ATTRIBUTES
  # Vendor conventions from Traceloop/OpenLLMetry for LLM observability
  # These are not official OTel semconvs but are part of our instrumentation
  # ==========================================================================
  - id: registry.cluster_whisperer.openllmetry
    type: attribute_group
    display_name: OpenLLMetry Attributes
    brief: OpenLLMetry/Traceloop attributes for LLM observability
    note: These are vendor conventions from Traceloop, not official OTel semconvs
    attributes:
      - id: traceloop.span.kind
        type:
          members:
            - id: workflow
              value: workflow
              brief: Top-level workflow span
              stability: development
            - id: tool
              value: tool
              brief: Tool execution span
              stability: development
            - id: task
              value: task
              brief: Task execution span
              stability: development
        stability: development
        brief: OpenLLMetry span category

      - id: traceloop.entity.name
        type: string
        stability: development
        brief: Entity identifier within the span kind
        examples: ["investigate", "kubectl_get", "kubectl_describe"]

      - id: traceloop.entity.input
        type: string
        stability: development
        brief: Input content (content-gated)
        note: Only captured when OTEL_CAPTURE_AI_PAYLOADS=true
        examples: ["{\"question\":\"Find the broken pod\"}"]

      - id: traceloop.entity.output
        type: string
        stability: development
        brief: Output content (content-gated)
        note: Only captured when OTEL_CAPTURE_AI_PAYLOADS=true
        examples: ["The pod 'nginx-broken' is failing due to ImagePullBackOff..."]
